name: CI/CD Pipeline

on:
  push:
    branches:
      - dev

jobs:
  build-celery-test:
    name: Build Test Celery for Scrapy News
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:19.03.5-dind
        options: --privileged
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to GitHub Container Registry
        run: echo "${{ secrets.GITHUB_TOKEN }}" | docker login ghcr.io -u "${{ secrets.REMOTE_DOCKER_USERNAME }}" --password-stdin

      - name: Docker Info
        run: docker info

      - name: Build Docker Image
        run: |
          docker build -f Dockerfile.celery.stagging --pull \
            --build-arg BACKEND_URL=${{ vars.TEST_BACKEND_URL }} \
            --build-arg NEWS_REDIS_URL=${{ vars.TEST_NEWS_REDIS_URL }} \
            --build-arg CRON_JOB_INTERVAL=${{ vars.TEST_NEWS_CRON_JOB_INTERVAL }} \
            --build-arg CONTENT_CREATE_TOKEN=${{ vars.TEST_CONTENT_CREATE_TOKEN }} \
            -t ghcr.io/quickfoxconsulting/quicksamachar_repo_django/news-celery-testing:latest .

      - name: Push Docker Image
        run: |
          docker push ghcr.io/quickfoxconsulting/quicksamachar_repo_django/news-celery-testing:latest

      - name: Logout from Docker Registry
        run: docker logout ghcr.io

  deploy-celery-test:
    name: Deploy Celery for Testing Scrapy News
    runs-on: ubuntu-latest
    needs: build-celery-test
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up SSH Key
        run: |
          echo "${{ secrets.AWS_SSH_KEY }}" > /tmp/id_rsa
          chmod 600 /tmp/id_rsa
        shell: bash

      - name: Test SSH Connection
        run: |
          ssh -vvv -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "echo 'SSH connection successful'"

      - name: Install Docker on Remote Server
        run: |
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "which docker || ( sudo apt update -y && sudo apt install -y apt-transport-https ca-certificates curl software-properties-common && curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add - && sudo add-apt-repository 'deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable' -y && sudo apt update -y && sudo apt install -y docker-ce )"

      - name: Log in to Docker Registry on Remote Server
        run: |
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "echo '${{ secrets.GITHUB_TOKEN }}' | sudo docker login ghcr.io -u '${{ secrets.REMOTE_DOCKER_USERNAME }}' --password-stdin"

      - name: Pull Docker Image on Remote Server
        run: |
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker pull ghcr.io/quickfoxconsulting/quicksamachar_repo_django/news-celery-testing:latest"

      - name: Remove Existing Docker Container
        run: |
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker container rm -f news-celery-testing || true"

      - name: Remove Existing Docker Containers for Workers
        run: |
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker container rm -f news-celery-testing-worker1 || true"
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker container rm -f news-celery-testing-worker2 || true"
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker container rm -f news-celery-testing-worker3 || true"
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker container rm -f news-celery-testing-worker4 || true"
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker container rm -f news-celery-testing-beat || true"

      - name: Run Docker Containers for Celery Workers
        run: |
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker run --net=host -e ROLE=worker1 -d --name=news-celery-testing-worker1 --restart unless-stopped ghcr.io/quickfoxconsulting/quicksamachar_repo_django/news-celery-testing:latest"
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker run --net=host -e ROLE=worker2 -d --name=news-celery-testing-worker2 --restart unless-stopped ghcr.io/quickfoxconsulting/quicksamachar_repo_django/news-celery-testing:latest"
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker run --net=host -e ROLE=worker3 -d --name=news-celery-testing-worker3 --restart unless-stopped ghcr.io/quickfoxconsulting/quicksamachar_repo_django/news-celery-testing:latest"
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker run --net=host -e ROLE=worker4 -d --name=news-celery-testing-worker4 --restart unless-stopped ghcr.io/quickfoxconsulting/quicksamachar_repo_django/news-celery-testing:latest"

      - name: Run Docker Container for Celery Beat
        run: |
          ssh -i /tmp/id_rsa -o StrictHostKeyChecking=no ${{ vars.TEST_HOST }} "sudo docker run --net=host -e ROLE=beat -d --name=news-celery-testing-beat --restart unless-stopped ghcr.io/quickfoxconsulting/quicksamachar_repo_django/news-celery-testing:latest"
